import { createRequire as _createRequire } from 'node:module';
const require = _createRequire(import.meta.url);
import{a as Z,b as j,c as B,d as J,e as g,f as C,g as M}from"./chunk-YCUOSGLG.js";import{f as k,i as N}from"./chunk-SKH2TXDX.js";import{b as d}from"./chunk-Q6WPLZZC.js";import{a as h,b as G}from"./chunk-XBIKRRQN.js";import"./chunk-6TDWVLRD.js";import{a as O}from"./chunk-Z6MBXKB5.js";import{d as A}from"./chunk-34HYWOQN.js";import"./chunk-CCZ55TG3.js";import{a as F}from"./chunk-ULZRRJS5.js";import"./chunk-XOWZQRGH.js";import"./chunk-QC5Y7QKP.js";import{d as I,e as q,f as D}from"./chunk-QKI65SFV.js";import{b as L}from"./chunk-SHTCM5ZT.js";import"./chunk-SPXP6KD4.js";import"./chunk-CNRVJIPG.js";import"./chunk-SYHT5LTW.js";import"./chunk-K656WQZA.js";import"./chunk-TVMTOQUC.js";import"./chunk-F67LDVCV.js";import{c as w}from"./chunk-ZBJRW65P.js";import"./chunk-J3IJS26Z.js";import"./chunk-CJ3JTOGS.js";import{i as E}from"./chunk-NUQ6G6J3.js";import"./chunk-3VDYJ2A2.js";import"./chunk-NWTFQJ5S.js";import{a as Y,c as P,e as R}from"./chunk-CU4HXYD6.js";import{e as U,i as s}from"./chunk-UO4ZAUJK.js";s();s();import{URL as ie}from"node:url";import{cwd as re,exit as se}from"node:process";var _=U(Z(),1),W=U(Y(),1);s();s();var ee={},te={};function oe(o){var t={"bo._base_domain_":[{srcPath:"/_serverless/typok",destPath:""}],"wixbo.ai":[{srcPath:"/_serverless/typok",destPath:""}],"editor._base_domain_":[{srcPath:"/_serverless/typok",destPath:""}],"blocks._base_domain_":[{srcPath:"/_serverless/typok",destPath:""}],"create.editorx":[{srcPath:"/_serverless/typok",destPath:""}]};return I(Object.assign(o,{domainToMappings:t}))}function $(o){var t=D(ee,{}),l=t.toJSON,a=t.fromJSON,i=D(te,{}).fromJSON;function n(e){var m=e.host,y=l(o),c={entityFqdn:"wix.typok.v1.siterevision",method:"GET",methodFqn:"wix.typok.v1.SiteRevisionService.GetSiteRevision",url:oe({protoPath:"/v1/site-revision",data:y,host:m}),params:q(y),transformResponse:i};return c}return n.fromReq=a,n.__isAmbassador=!0,n}var z=async o=>{try{return(await h({type:"editor",authState:o.authState},$({}))).data.siteRevision?.revision??null}catch(t){o.logger.logFailedToGetLatestRevision(t)}return null};var ae=o=>{let t=new ie(o);return`${t.protocol}//${t.host}${t.pathname}`};async function le({biLogger:o,errorReporter:t},l){let a=await A(re()),i=await O({metaSiteId:a.metaSiteId,biLogger:o,errorReporter:t}),n=F(),e=G({t:n}),m=await j(r=>L(E(a.projectFolder),r)),c=(l.source?{value:l.source}:await(0,_.default)({type:"select",name:"value",message:e.t("publish_command.prompt_what_to_publish"),choices:[{title:w.cyan(m?e.t("publish_command.prompt_what_to_publish_choice_remote",{branchName:m}):e.t("publish_command.prompt_what_to_publish_choice_remote_fallback")),value:"remote"},{title:w.cyan(e.t("publish_command.prompt_what_to_publish_choice_local")),value:"local"}]},{onCancel:()=>{e.logAborting(),se(130)}})).value==="local"?g.local():g.remote({}),v,b=e.logPreviewing();try{v=await C({model:a,operation:k.RC,source:c,authState:i}),b.success()}catch(r){if(N(r))b.stop(),e.logPreviewUnsupported();else throw b.fail(),r}let V=await z({authState:i,logger:e}),H=v?.deployedRevision??a.revision;if(e.logPublishRevision({branchName:m,isLocalDeployment:(0,W.isType)(c,g.local),currentRevision:H,latestRevision:V,preview:v}),(l.approvePreview?{value:!0}:await(0,_.default)({type:"confirm",name:"value",message:e.t("publish_command.prompt_continue_with_publish"),initial:!0})).value){let r=e.logDeploying(),x=v??await C({model:a,authState:i,operation:k.GA,source:c}),{deploymentId:T,deploymentUrl:K,isPublishPipelineDeployment:Q}=x,f;try{f=Q?await M({deploymentId:T,authState:i}):d.SUCCESS}catch(u){throw r.fail(),u}f===d.SUCCESS&&r.success();let S;if(f===d.ERROR){r.fail();try{let{data:p}=await h({type:"editor",authState:i},J({deploymentId:x.deploymentId,deploymentPipelinesIds:["5c696513-2584-4f19-ae0f-a559dd649482"]}),{retries:2});if(p.pipelinesDescription?.length){let{pipelinesDescription:X}=p;e.logPipelineErrorInformation({pipelinesDescription:X})}}catch(p){throw new P({code:R.FailedToGetPipelineErrorInfo(),cause:p})}e.logForceDeployWarning(),S=(l.force?{value:!0}:await(0,_.default)({type:"confirm",name:"value",message:n("publish_command.prompt_publish_with_error"),initial:!0})).value}if(f===d.SUCCESS||S){let u=e.logPublishing();try{await h({type:"editor",authState:i},B({deploymentId:T,skipPipelineCheck:S}),{retries:2})}catch(p){throw u.fail(),new P({code:R.FailedToPublishDeployment(),cause:p})}u.success({siteUrl:ae(K)})}}else e.logPublishAborted()}export{le as publish};
//# sourceMappingURL=publish-KHEPZGLL.js.map