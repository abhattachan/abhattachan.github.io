{"version":3,"sources":["../../cli-site/src/dependency-manager/utils.ts","../../cli-site/src/dependency-manager/packages-service.ts","../../../node_modules/@wix/ambassador-velo-npm-v1-npm-package-info/http.impl.ts","../../cli-site/src/files/package-json.ts","../../cli-site/src/files/wix.lock.ts","../../cli-site/src/dependency-manager/index.ts","../../cli-site/src/dependency-manager/yarn.ts","../../cli-site/src/dependency-manager/npm.ts"],"sourcesContent":["import path from 'node:path';\nimport { pathExists } from '@wix/cli-fs';\n\nexport type PackageManager = 'yarn' | 'npm';\n\nexport const isYarn = async (root: string) => {\n  return pathExists(path.join(root, 'yarn.lock'));\n};\n\nexport const getDefaultPackageManager = async (root: string) => {\n  const shouldUseYarn = await isYarn(root);\n  return shouldUseYarn ? 'yarn' : 'npm';\n};\n","import {\n  resolveNpmDependencies as resolveNpmDependenciesRequest,\n  getResolveNpmDependenciesResult,\n} from '@wix/ambassador-velo-npm-v1-npm-package-info/http';\nimport pWaitFor from 'p-wait-for';\nimport type { AuthState } from '@wix/cli-auth';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\nimport { isHttpError } from '@wix/cli-http-client';\nimport { httpRequest } from '../http-request.js';\nimport { getDependencies } from '../files/package-json.js';\nimport { saveWixLock } from '../files/wix.lock.js';\nimport {\n  resolveNpmDependenciesSchema,\n  npmDependenciesLockFileResponseSchema,\n} from '../schemas.js';\n\ninterface RequestOptions {\n  authState: AuthState;\n}\n\nconst waitForInstallationCompleted = async (\n  jobId: string,\n  { authState }: RequestOptions\n) => {\n  return pWaitFor(\n    async () => {\n      try {\n        const { data } = await httpRequest(\n          { type: 'editor', authState },\n          getResolveNpmDependenciesResult({ jobId })\n        );\n\n        const npmDependenciesLockFileResponse =\n          npmDependenciesLockFileResponseSchema.parse(data);\n\n        return pWaitFor.resolveWith({\n          wixLockFileUrl:\n            npmDependenciesLockFileResponse.result.npmDependenciesLockFile,\n        });\n      } catch (e) {\n        // Continue polling\n        if (isHttpError(e) && e.response?.status === 428) {\n          return false;\n        }\n        // Unexpected error - stop polling\n        throw new CliError({\n          code: CliErrorCode.FailedToGetResolveNpmDependenciesResult(),\n          cause: e,\n        });\n      }\n    },\n    {\n      // Poll each 3 seconds\n      interval: 3 * 1000,\n      // Fail if 2 minutes passed\n      timeout: 2 * 60 * 1000,\n    }\n  );\n};\n\nconst fetchAndSaveWixLock = async (url: string, root: string) => {\n  const wixLockContent = await httpRequest<string>(\n    { type: 'standalone' },\n    { url }\n  );\n  return saveWixLock(root, wixLockContent.data);\n};\n\nexport const resolveNpmDependencies = async (\n  root: string,\n  { authState }: RequestOptions\n) => {\n  try {\n    const npmPackageInfos = await getDependencies(root);\n\n    const { data: resolveNpmDependenciesResponse } = await httpRequest(\n      { type: 'editor', authState },\n      resolveNpmDependenciesRequest({ npmPackageInfos })\n    );\n\n    const { jobId } = resolveNpmDependenciesSchema.parse(\n      resolveNpmDependenciesResponse\n    );\n\n    const { wixLockFileUrl } = await waitForInstallationCompleted(jobId, {\n      authState,\n    });\n\n    await fetchAndSaveWixLock(wixLockFileUrl, root);\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToResolveNpmDependencies(),\n      cause: e,\n    });\n  }\n};\n",null,"import { join } from 'node:path';\nimport type { PackageJson } from 'type-fest';\nimport { readJson, writeJson } from '@wix/cli-fs';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\n\nexport async function getDependencies(projectFolder: string) {\n  const packageJsonPath = join(projectFolder, 'package.json');\n  const packageJson = (await readJson(packageJsonPath)) as PackageJson;\n  return Object.entries(packageJson.dependencies ?? {}).map(\n    ([name, version]) => ({ name, version })\n  );\n}\n\nexport async function addDependenciesToPackageJson(\n  projectFolder: string,\n  dependenciesConfig: {\n    dependencies: Record<string, string>;\n  }\n) {\n  const packageJsonPath = join(projectFolder, 'package.json');\n  const packageJson = (await readJson(packageJsonPath)) as PackageJson;\n\n  if (\n    packageJson.dependencies &&\n    Object.keys(packageJson.dependencies).length > 0\n  ) {\n    throw new CliError({\n      code: CliErrorCode.FailedMigrationToAnyNpm(),\n    });\n  }\n\n  packageJson.dependencies = {};\n\n  Object.keys(dependenciesConfig.dependencies).forEach(\n    (dependencyPackageName) => {\n      if (packageJson.devDependencies?.[dependencyPackageName]) {\n        delete packageJson.devDependencies[dependencyPackageName];\n      }\n\n      packageJson.dependencies![dependencyPackageName] =\n        dependenciesConfig.dependencies[dependencyPackageName];\n    }\n  );\n\n  await writeJson(packageJsonPath, packageJson);\n}\n","import { join } from 'node:path';\nimport { WIX_LOCK_FILENAME } from '@wix/cli-core-definitions';\nimport { outputFile } from '@wix/cli-fs';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\n\nexport async function saveWixLock(\n  projectFolder: string,\n  lockFileContent: string\n) {\n  const wixLockPath = join(projectFolder, WIX_LOCK_FILENAME);\n  try {\n    await outputFile(wixLockPath, lockFileContent);\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToWriteWixLock(),\n      cause: e,\n    });\n  }\n}\n","import { CliError, CliErrorCode } from '@wix/cli-error';\nimport type { PackageManager } from './utils.js';\nimport {\n  installPackage as installPackageYarn,\n  installAll as installAllYarn,\n  uninstallPackage as uninstallPackageYarn,\n} from './yarn.js';\nimport {\n  installPackage as installPackageNpm,\n  installAll as installAllNpm,\n  uninstallPackage as uninstallPackageNpm,\n} from './npm.js';\n\nexport const installNpmPackage = async (\n  packageName: string,\n  version: string | null,\n  root: string,\n  packageManager: PackageManager\n) => {\n  try {\n    if (packageManager === 'yarn') {\n      await installPackageYarn(packageName, version, root);\n    } else {\n      await installPackageNpm(packageName, version, root);\n    }\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToInstallPackage({ packageName, cause: e }),\n      cause: e,\n    });\n  }\n};\n\nexport const uninstallNpmPackage = async (\n  packageName: string,\n  root: string,\n  packageManager: PackageManager\n) => {\n  try {\n    if (packageManager === 'yarn') {\n      await uninstallPackageYarn(packageName, root);\n    } else {\n      await uninstallPackageNpm(packageName, root);\n    }\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToUninstallPackage({ packageName, cause: e }),\n      cause: e,\n    });\n  }\n};\n\nexport const installAllPackages = async (\n  root: string,\n  packageManager: PackageManager\n) => {\n  try {\n    if (packageManager === 'yarn') {\n      await installAllYarn(root);\n    } else {\n      await installAllNpm(root);\n    }\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToInstallPackages({ cause: e }),\n      cause: e,\n    });\n  }\n};\n\nexport * from './utils.js';\nexport * from './packages-service.js';\n","import { execa } from 'execa';\n\nexport const installPackage = async (\n  packageName: string,\n  version: string | null,\n  root: string\n) => {\n  const args = ['add', `${packageName}${version ? `@${version}` : ''}`];\n\n  return execa('yarn', args, {\n    cwd: root,\n  });\n};\n\nexport const uninstallPackage = (packageName: string, root: string) => {\n  return execa('yarn', ['remove', packageName], {\n    cwd: root,\n  });\n};\n\nexport const installAll = (root: string) => {\n  return execa('yarn', ['install'], {\n    cwd: root,\n  });\n};\n","import { execa } from 'execa';\n\nexport const installPackage = async (\n  packageName: string,\n  version: string | null,\n  root: string\n) => {\n  const args = ['install', `${packageName}${version ? `@${version}` : ''}`];\n\n  return execa('npm', args, {\n    cwd: root,\n  });\n};\n\nexport const uninstallPackage = (packageName: string, root: string) => {\n  return execa('npm', ['uninstall', packageName], {\n    cwd: root,\n  });\n};\n\nexport const installAll = (root: string) => {\n  return execa('npm', ['install'], {\n    cwd: root,\n  });\n};\n"],"mappings":"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","names":["init_esm_shims","path","isYarn","root","pathExists","path","getDefaultPackageManager","init_esm_shims","init_esm_shims","_getResolveNpmDependenciesResultRequest","_getResolveNpmDependenciesResultResponse","_resolveNpmDependenciesRequest","_resolveNpmDependenciesResponse","resolveWixVeloNpmV1UserCodeNpmPackagesUrl","opts","domainToMappings","resolveUrl","resolveNpmDependencies","payload","_a","serializer","_resolveNpmDependenciesRequest","toReq","fromReq","fromRes","_resolveNpmDependenciesResponse","__resolveNpmDependencies","host","serializedData","metadata","resolveWixVeloNpmV1UserCodeNpmPackagesUrl","getResolveNpmDependenciesResult","_getResolveNpmDependenciesResultRequest","_getResolveNpmDependenciesResultResponse","__getResolveNpmDependenciesResult","toURLSearchParams","init_esm_shims","join","getDependencies","projectFolder","packageJsonPath","join","packageJson","readJson","name","version","addDependenciesToPackageJson","dependenciesConfig","CliError","CliErrorCode","dependencyPackageName","writeJson","init_esm_shims","join","saveWixLock","projectFolder","lockFileContent","wixLockPath","join","WIX_LOCK_FILENAME","outputFile","e","CliError","CliErrorCode","waitForInstallationCompleted","jobId","authState","pWaitFor","data","httpRequest","getResolveNpmDependenciesResult","npmDependenciesLockFileResponse","npmDependenciesLockFileResponseSchema","e","isHttpError","CliError","CliErrorCode","fetchAndSaveWixLock","url","root","wixLockContent","saveWixLock","resolveNpmDependencies","npmPackageInfos","getDependencies","resolveNpmDependenciesResponse","resolveNpmDependenciesSchema","wixLockFileUrl","init_esm_shims","init_esm_shims","installPackage","packageName","version","root","args","execa","uninstallPackage","installAll","init_esm_shims","installPackage","packageName","version","root","args","execa","uninstallPackage","installAll","installNpmPackage","packageName","version","root","packageManager","installPackage","e","CliError","CliErrorCode","uninstallNpmPackage","uninstallPackage","installAllPackages","installAll"]}